<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹swap_transfer.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹swap_transfer.ML›</h1>
</div>

<pre class="source"> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">swapty</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'i</span></span><span class="antiquote">}</span></span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'j</span></span><span class="antiquote">}</span></span>
    <span class="main">|</span> <span class="entity">swapty</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'j</span></span><span class="antiquote">}</span></span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'i</span></span><span class="antiquote">}</span></span>
    <span class="main">|</span> <span class="entity">swapty</span> <span class="main">(</span>Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span><span class="main">[</span><span class="entity">u</span><span class="main">,</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">swapty</span> <span class="entity">u</span> --&gt; <span class="entity">swapty</span> <span class="entity">t</span>
    <span class="main">|</span> <span class="entity">swapty</span> <span class="entity">ty</span> <span class="main">=</span> <span class="entity">ty</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">restrict_vars</span> <span class="main">[</span><span class="main">]</span> <span class="entity">B</span> <span class="main">=</span> <span class="entity">B</span>
    <span class="main">|</span> <span class="entity">restrict_vars</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="entity">B</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> conj<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="keyword1">M</span></span><span class="antiquote">}</span></span> $ Var <span class="entity">x</span><span class="main">)</span> $ <span class="entity">restrict_vars</span> <span class="entity">xs</span> <span class="entity">B</span>
 
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">swap</span> <span class="entity">i</span> <span class="entity">B</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> fastype_of <span class="entity">B</span> <span class="keyword2"><span class="keyword">of</span></span> 
       <span class="main">(</span>Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span><span class="main">[</span><span class="entity">u</span><span class="main">,</span><span class="main">_</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"x"</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">swapty</span> <span class="entity">u</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
          lambda <span class="entity">x</span> <span class="main">(</span><span class="entity">swap</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">B</span> $ <span class="main">(</span><span class="entity">swap</span> <span class="main">(</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
     <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'i</span></span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Abs</span></span><span class="antiquote">}</span></span> $ <span class="entity">B</span>
     <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'j</span></span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">Rep</span></span><span class="antiquote">}</span></span> $ <span class="entity">B</span>
     <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> <span class="entity">B</span>
     <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"weird type!"</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_swaps</span> <span class="entity">mdl</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msig</span> <span class="main">{</span><span class="entity">name</span><span class="main">,</span> <span class="entity">target</span><span class="main">,</span> <span class="entity">sigmap</span><span class="main">}</span> <span class="main">=</span> <span class="entity">mdl</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cons</span> <span class="main">=</span> <span class="entity">loc_consts</span> <span class="entity">ctxt</span> <span class="entity">target</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mconst_of</span> <span class="main">=</span> <span class="entity">app_sigmap</span> <span class="entity">sigmap</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nameof</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">n</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">in</span></span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">mconst_of</span> <span class="entity">c</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">"c"</span> ^ <span class="entity">nameof</span> <span class="entity">c</span><span class="main">,</span> <span class="main">(</span><span class="entity">swap</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">mconst_of</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">cons</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_defn</span> <span class="entity">name</span> <span class="entity">trm</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binding_const</span> <span class="main">=</span> <span class="main">(</span>Binding.name <span class="entity">name</span><span class="main">,</span> NoSyn<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binding_fact</span> <span class="main">=</span> <span class="main">(</span>Binding.name <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">"_def"</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg</span> <span class="main">=</span> <span class="main">(</span><span class="entity">binding_const</span><span class="main">,</span> <span class="main">(</span><span class="entity">binding_fact</span><span class="main">,</span> <span class="entity">trm</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span> <span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">=</span> Local_Theory.define <span class="entity">arg</span> <span class="entity">lthy</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">lthy'</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">defn_swaps</span> <span class="entity">swaps</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_def</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">make_defn</span> <span class="entity">n</span> <span class="entity">t</span> 
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_def</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Context.map_proof <span class="main">(</span><span class="entity">get_def</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> 
                        |&gt; Context.proof_map<span class="main">)</span>  
  <span class="keyword2"><span class="keyword">in</span></span> List.foldl <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">,</span><span class="entity">ct</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">add_def</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="entity">ct</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">swaps</span> <span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">type_transfer_rel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'j</span></span><span class="antiquote">}</span></span>   <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">md</span><span class="antiquote">}</span></span>
  <span class="main">|</span> <span class="entity">type_transfer_rel</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">iff</span><span class="antiquote">}</span></span>
  <span class="main">|</span> <span class="entity">type_transfer_rel</span> <span class="main">(</span>Type <span class="main">(</span><span class="inner_quoted">"fun"</span><span class="main">,</span><span class="main">[</span><span class="entity">u</span><span class="main">,</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      Const <span class="main">(</span><span class="inner_quoted">"BNF_Def.rel_fun"</span><span class="main">,</span> 
         <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span>
           $ <span class="entity">type_transfer_rel</span> <span class="entity">u</span> $  <span class="entity">type_transfer_rel</span> <span class="entity">t</span>

 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_transfer_rule</span> <span class="entity">c1</span> <span class="entity">c2</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ty</span> <span class="main">=</span> fastype_of <span class="entity">c2</span>
   <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">transfer_rel</span> <span class="main">=</span> Syntax.check_term <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">type_transfer_rel</span> <span class="entity">ty</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">transfer_rel</span> $ <span class="entity">c1</span> $ <span class="entity">c2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>   

 <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_transfer_rules</span> <span class="entity">swaps</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">con_pairs</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">mc</span><span class="main">,</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">mc</span><span class="main">,</span> Syntax.read_term <span class="entity">ctxt</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="entity">swaps</span> 
  <span class="keyword2"><span class="keyword">in</span></span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">mc</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">gen_transfer_rule</span> <span class="entity">mc</span> <span class="entity">c</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">con_pairs</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> 
  
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lift_model_defs_cmd</span> <span class="main">(</span><span class="entity">thm_name</span><span class="main">,</span> <span class="entity">src</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mdl</span> <span class="main">=</span> <span class="entity">src_to_model</span> <span class="entity">src</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">swaps</span> <span class="main">=</span> <span class="entity">gen_swaps</span> <span class="entity">mdl</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt'</span> <span class="main">=</span> <span class="entity">defn_swaps</span> <span class="main">(</span>map snd <span class="entity">swaps</span><span class="main">)</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> <span class="entity">gen_transfer_rules</span> <span class="entity">swaps</span> <span class="entity">ctxt'</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Proof.theorem</span> NONE <span class="main">(</span><span class="entity">after_qed</span> <span class="entity">thm_name</span><span class="main">)</span> <span class="main">[</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="entity">goals</span><span class="main">]</span> <span class="entity">ctxt'</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> "<span class="keyword1">lift_model_defs</span>"<span class="antiquote">}</span></span></span>
        <span class="inner_quoted">"sets up proof state for showing model is closed under a sequence of constants"</span> 
        <span class="main">(</span><span class="entity">Parse_Spec.opt_thm_name</span> <span class="inner_quoted">":"</span> -- Parse.ML_source  &gt;&gt; <span class="entity">lift_model_defs_cmd</span><span class="main">)</span></pre>
</body>

</html>